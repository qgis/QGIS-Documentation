<select id="languages">
  <!-- note on the options here: the 'title' string is to be translated in your
  language, but the element text is supposed to stay in native lang/txt -->
  <option value="en" title="{{ _('English') }}">English</option>
  <option value="de" title="{{ _('German') }}">Deutsch</option>
  <option value="es" title="{{ _('Spanish') }}">Español</option>
  <option value="fi" title="{{ _('Finnish') }}">Suomalainen</option>
  <option value="fr" title="{{ _('French') }}">Français</option>
  <option value="gl" title="{{ _('Galician') }}">Galician</option>
  <option value="hi" title="{{ _('Hindi') }}">Hindi</option>
  <option value="id" title="{{ _('Indonesian') }}">Bahasa Indonesia</option>
  <option value="ja" title="{{ _('Japanese') }}">日本語</option>
  <option value="it" title="{{ _('Italian') }}">Italiano</option>
  <option value="ko" title="{{ _('Korean') }}">한국어</option>
  <option value="nl" title="{{ _('Dutch') }}">Nederlands</option>
  <!-- nqo is not available as python locale -->
  <!--<option value="nqo" title="{{ _('N''qo') }}">N'qo</option>-->
  <option value="pl" title="{{ _('Polish') }}">Polski</option>
  <option value="pt_PT" title="{{ _('Portuguese') }}">Português</option>
  <option value="pt_BR" title="{{ _('Portuguese (Brazil)') }}">Português (Brazil)</option>
  <option value="ro" title="{{ _('Romanian') }}">Română</option>
  <option value="ru" title="{{ _('Russian') }}">Русский</option>
  <option value="uk" title="{{ _('Ukrainian') }}">Українська</option>
</select>

<script>
    var currentPage = '{{current_page_name}}.html'; // coming from sphinx, always without starting '/'
    var currentLang = 'en';
    // split index.html if currentUrl is ended by '/'
    var currentUrl = window.location.href;
    if (currentUrl.slice(-1) == '/' && currentPage.slice(-1) != '/'){
      var pages = currentPage.split('/');
      pages.pop();
      currentPage = pages.join('/') + '/';
    }
    $(document).ready(function(){
        var search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
        var langPlusPage = window.location.href.match(search);
        // it's possible this is the index.html page called without 'index.html', try without the currentPage
        if (langPlusPage==undefined){
            search = new RegExp('\/[a-zA-Z_]{2,8}\/$', 'gi');
            langPlusPage = window.location.href.match(search);
        }
        // it's possible this is an index.html page called without 'index.html', try removing index.html
        if (langPlusPage==undefined){
            currentPage = currentPage.replace('index.html','')
            search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
            langPlusPage = window.location.href.match(search);
        }
        // still no langPlugPage: stop, because the language swicher will misbehave
        if (langPlusPage == undefined || langPlusPage.length != 1){
            alert('This is an documentation error, please report back to QGIS devs.');
            return;
        }
        langPlusPage = langPlusPage[0];
        currentLang = langPlusPage.replace(currentPage, '');

        // TODO: links should come from conf.py
        // TODO: all template pages have the actual translation in sphinc.conf
        // IMPORTANT: space, -, _ etc replacing below must be 100% inline with
        // code in scripts/create_transifex_resources.sh !!
        // https://github.com/qgis/QGIS-Website/blob/master/scripts/create_transifex_resources.sh
        fix_translation_link = 'https://www.transifex.com/projects/p/qgis-documentation/translate/#' + 
            currentLang.slice(1) + currentPage.replace(/_/g, "-").replace(/ /g, "-").replace(/\//g, "_").replace(/\.html/g, "").replace(/\./g, "-")
        if ('/en/' != currentLang) {
            $('#fix_translation_link').attr('href', fix_translation_link);
        }
        fix_text_link = 'https://github.com/qgis/QGIS-Documentation/edit/master/source/' +
            currentPage.replace(/.html/g, ".rst")
        // TODO: only on rst pages, here a list of pages which are actual templates?
        if (true){
            $('#fix_text_link').attr('href', fix_text_link);
        }

        $("#languages").val(currentLang.replace(/\//g,'')); // currentLang is something like '/nl/'

        $("#languages").change(function() {
            gotoLang($(this).val());
        });

    });

    // load current page in a different language
    function gotoLang(lang){
        var currentUrl = window.location.href;
        var newUrl = currentUrl.replace(currentLang, '/'+lang+'/');
        window.location.href = newUrl;
    }
</script>
